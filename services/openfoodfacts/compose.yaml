services:
  off-api:
    labels:
      - traefik.enable=true
      - traefik.http.routers.openfoodfacts.rule=Host(`off.gryta.eu`)
      - traefik.http.routers.openfoodfacts.entrypoints=websecure
      - traefik.http.routers.openfoodfacts.tls.certresolver=le
      - traefik.http.services.openfoodfacts.loadbalancer.server.port=8000
    image: ghcr.io/rgryta/openfoodfacts-api:v1.1.0
    container_name: openfoodfacts-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://offuser:${POSTGRES_PASSWORD}@homelab-postgres:5432/openfoodfacts
      API_KEYS: ${API_KEYS}
      LOG_LEVEL: INFO
    networks:
      homelab-network:
        ipv4_address: 172.20.0.111
    healthcheck:
      test:
        - CMD-SHELL
        - wget --no-verbose --tries=1 -O- http://localhost:8000/health >
          /dev/null 2>&1 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  off-updater:
    image: ghcr.io/rgryta/openfoodfacts-updater:v1.1.0
    container_name: openfoodfacts-updater
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://offuser:${POSTGRES_PASSWORD}@homelab-postgres:5432/openfoodfacts
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      OFF_DELTA_URL: https://static.openfoodfacts.org/data/delta
      OFF_JSONL_URL: https://static.openfoodfacts.org/data/openfoodfacts-products.jsonl.gz
      LOG_LEVEL: INFO
    volumes:
      - off-data-cache:/app/data
    networks:
      homelab-network:
        ipv4_address: 172.20.0.112
volumes:
  off-data-cache:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /mnt/archive/apps/volumes/openfoodfacts/data-cache
networks:
  homelab-network:
    external: true
