services:
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    labels:
      - traefik.enable=true
      # Priority: API router (higher) takes precedence for /rest/* paths
      - traefik.http.routers.navidrome-api.priority=100
      - traefik.http.routers.navidrome.priority=10
      # ==========================================
      # SECURE ROUTER (Web UI - Requires Authentik)
      # ==========================================
      - traefik.http.routers.navidrome.rule=Host(`navidrome.gryta.eu`)
      - traefik.http.routers.navidrome.entrypoints=websecure
      - traefik.http.routers.navidrome.tls.certresolver=le
      - traefik.http.routers.navidrome.service=navidrome
      - traefik.http.routers.navidrome.middlewares=authentik-forward-auth@file
      # ==========================================
      # API ROUTER (Subsonic API - No Authentik)
      # ==========================================
      - traefik.http.routers.navidrome-api.rule=Host(`navidrome.gryta.eu`) && PathPrefix(`/rest`)
      - traefik.http.routers.navidrome-api.entrypoints=websecure
      - traefik.http.routers.navidrome-api.tls.certresolver=le
      - traefik.http.routers.navidrome-api.service=navidrome
      # ==========================================
      # SERVICE CONFIG
      # ==========================================
      - traefik.http.services.navidrome.loadbalancer.server.port=4533
    networks:
      homelab-network:
        ipv4_address: 172.20.0.107
    volumes:
      - navidrome_data:/data
      - navidrome_music:/music:ro
    environment:
      - ND_SCANSCHEDULE=1h
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_BASEURL=
    user: "1000:1000"

volumes:
  navidrome_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/quick/apps/volumes/navidrome/data
  navidrome_music:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/archive/media/All/Music

networks:
  homelab-network:
    external: true
