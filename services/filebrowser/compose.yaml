services:
  filebrowser:
    labels:
      - traefik.enable=true
      - traefik.http.routers.filebrowser-public.priority=100
      - traefik.http.routers.filebrowser.priority=10
      # ==========================================
      # SECURE ROUTER (Requires Authentik)
      # ==========================================
      - traefik.http.routers.filebrowser.rule=Host(`filebrowser.gryta.eu`)
      - traefik.http.routers.filebrowser.entrypoints=websecure
      - traefik.http.routers.filebrowser.tls.certresolver=le
      - traefik.http.routers.filebrowser.service=filebrowser
      - traefik.http.routers.filebrowser.middlewares=authentik-forward-auth@file
      # ==========================================
      # PUBLIC ROUTER (/share/* bypasses Auth)
      # ==========================================
      - traefik.http.routers.filebrowser-public.rule=Host(`filebrowser.gryta.eu`)
        && (PathPrefix(`/share`) || PathPrefix(`/static`) ||
        PathPrefix(`/api/public`))
      - traefik.http.routers.filebrowser-public.entrypoints=websecure
      - traefik.http.routers.filebrowser-public.tls.certresolver=le
      - traefik.http.routers.filebrowser-public.service=filebrowser
      # ==========================================
      # SERVICE CONFIG
      # ==========================================
      - traefik.http.services.filebrowser.loadbalancer.passhostheader=true
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    restart: unless-stopped
    networks:
      homelab-network:
        ipv4_address: 172.20.0.102
    volumes:
      - filebrowser_db:/database
      - filebrowser_data:/srv/Data
      - filebrowser_slow:/srv/Slow
      - filebrowser_media:/srv/Media
      - filebrowser_qmedia:/srv/QMedia
    user: 1000:1000
volumes:
  filebrowser_db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/quick/apps/volumes/filebrowser/db
  filebrowser_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/quick/apps/volumes/filebrowser/data
  filebrowser_slow:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/archive/apps/volumes/filebrowser/slow
  filebrowser_media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/archive/media
  filebrowser_qmedia:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/quick/media
networks:
  homelab-network:
    external: true
