services:
  uv:
    labels:
      - traefik.enable=false
    image: ghcr.io/astral-sh/uv:debian-slim
    container_name: uv
    volumes:
      - /opt/python
    entrypoint:
      - sh
      - -c
      - |
        uv python install 3.12 --install-dir /opt/python_tmp &&
        rm -rf /opt/python/* &&
        cp -a /opt/python_tmp/cpython-*/* /opt/python/ &&
        rm -rf /opt/python_tmp &&
        chown -R 1000:1000 /opt/python &&
        tail -f /dev/null
    restart: unless-stopped
  android:
    labels:
      - traefik.enable=false
    image: ghcr.io/rgryta/android-sdk:main
    container_name: android
    volumes:
      - /opt/java/openjdk
      - /opt/android-sdk
    command: tail -f /dev/null
    user: node
    restart: unless-stopped
  node:
    labels:
      - traefik.enable=false
    image: node:20-bullseye
    container_name: node
    volumes:
      - /opt/node
    entrypoint:
      - sh
      - -c
      - |
        rm -rf /opt/node/* &&
        cp -a /usr/local/* /opt/node/ &&
        chown -R 1000:1000 /opt/node &&
        tail -f /dev/null
    restart: unless-stopped
  tools:
    labels:
      - traefik.enable=false
    image: debian:bookworm-slim
    container_name: tools
    environment:
      - TOOLS_REINSTALL=${TOOLS_REINSTALL:-true}
    volumes:
      - /opt/tools
      - gcloud_config:/opt/tools/gcloud-config
    entrypoint:
      - sh
      - -c
      - |
        set -e
        # Skip reinstall unless TOOLS_REINSTALL is set
        if [ "$TOOLS_REINSTALL" != "true" ]; then
          echo "TOOLS_REINSTALL not set, skipping..."
          exec tail -f /dev/null
        fi
        rm -rf /opt/tools/* 2>/dev/null || true
        mkdir -p /opt/tools/bin
        # Install dependencies
        apt-get update && apt-get install -y --no-install-recommends \
          make curl unzip wget ca-certificates gnupg nmap \
          && apt-get clean && rm -rf /var/lib/apt/lists/*
        # Install make
        cp /usr/bin/make /opt/tools/bin/
        # Install nmap with required libraries and wrapper script
        cp /usr/bin/nmap /opt/tools/bin/nmap.bin
        mkdir -p /opt/tools/lib /opt/tools/share
        for lib in $$(ldd /usr/bin/nmap | grep -o '/[^ ]*'); do
          cp -n "$$lib" /opt/tools/lib/ 2>/dev/null || true
        done
        cp -r /usr/share/nmap /opt/tools/share/nmap
        printf '#!/bin/sh\nexec env LD_LIBRARY_PATH=/opt/tools/lib /opt/tools/bin/nmap.bin "$$@"\n' > /opt/tools/bin/nmap
        chmod +x /opt/tools/bin/nmap
        # Install GitHub CLI
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
          -o /usr/share/keyrings/githubcli-archive-keyring.gpg
        chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
          > /etc/apt/sources.list.d/github-cli.list
        apt-get update && apt-get install -y gh && apt-get clean && rm -rf /var/lib/apt/lists/*
        cp /usr/bin/gh /opt/tools/bin/
        # Install Google Chrome (headless)
        curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
          | gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" \
          > /etc/apt/sources.list.d/google-chrome.list
        apt-get update && apt-get install -y google-chrome-stable && apt-get clean && rm -rf /var/lib/apt/lists/*
        cp /usr/bin/google-chrome-stable /opt/tools/bin/google-chrome
        # Install gcloud CLI (for App Engine, BigQuery, Cloud SQL)
        curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg \
          | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
          > /etc/apt/sources.list.d/google-cloud-sdk.list
        apt-get update && apt-get install -y google-cloud-cli \
          google-cloud-cli-app-engine-python google-cloud-cli-app-engine-python-extras \
          google-cloud-cli-cloud-run-proxy google-cloud-cli-gke-gcloud-auth-plugin \
          && apt-get clean && rm -rf /var/lib/apt/lists/*
        # Copy entire gcloud SDK (symlinks won't work across containers)
        cp -a /usr/lib/google-cloud-sdk /opt/tools/
        # Install Docker CLI
        curl -fsSL https://download.docker.com/linux/debian/gpg \
          | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bookworm stable" \
          > /etc/apt/sources.list.d/docker.list
        apt-get update && apt-get install -y docker-ce-cli && apt-get clean && rm -rf /var/lib/apt/lists/*
        cp /usr/bin/docker /opt/tools/bin/
        ln -sf /opt/tools/google-cloud-sdk/bin/gcloud /opt/tools/bin/gcloud
        ln -sf /opt/tools/google-cloud-sdk/bin/gsutil /opt/tools/bin/gsutil
        ln -sf /opt/tools/google-cloud-sdk/bin/bq /opt/tools/bin/bq
        # Configure gcloud to use persistent config directory
        mkdir -p /opt/tools/gcloud-config
        chown -R 1000:1000 /opt/tools
        echo "Tools installation complete"
        exec tail -f /dev/null
    restart: unless-stopped
  vscode:
    labels:
      - traefik.enable=true
      - traefik.http.routers.vscode.rule=Host(`vscode.gryta.eu`)
      - traefik.http.routers.vscode.entrypoints=websecure
      - traefik.http.routers.vscode.tls.certresolver=le
      - traefik.http.routers.vscode.middlewares=authentik-forward-auth@file
      - traefik.http.services.vscode.loadbalancer.server.port=8443
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    volumes_from:
      - android
      - uv
      - node
      - tools
    volumes:
      - vscode_config:/config
      - homelab_stack:/homelab_stack:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Warsaw
      - DOCKER_HOST=unix:///var/run/docker.sock
      - ATTACHED_DEVICES_PERMS=/var/run/docker.sock
      - HASHED_PASSWORD=${HASHED_PASSWORD}
      - SUDO_PASSWORD_HASH=${HASHED_PASSWORD}
      - PROXY_DOMAIN=vscode.gryta.eu
      - DEFAULT_WORKSPACE=/config/workspace
      - PWA_APPNAME=code-server
      - 'EXTENSIONS_GALLERY={"serviceUrl":
        "https://marketplace.visualstudio.com/_apis/public/gallery", "itemUrl":
        "https://marketplace.visualstudio.com/items"}'
      - JAVA_HOME=/opt/java/openjdk
      - ANDROID_HOME=/opt/android-sdk
      - PATH=/opt/tools/bin:/opt/python/bin:/opt/node/bin:/opt/java/openjdk/bin:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools:$PATH
      - CLOUDSDK_CONFIG=/opt/tools/gcloud-config
    depends_on:
      - android
      - uv
      - node
      - tools
    restart: unless-stopped
    networks:
      homelab-network:
        ipv4_address: 172.20.0.25
volumes:
  vscode_config:
    driver_opts:
      o: bind
      type: none
      device: /mnt/quick/apps/volumes/vscode/config
  homelab_stack:
    driver_opts:
      o: bind
      type: none
      device: /mnt/.ix-apps/app_mounts/dockge/stacks
  gcloud_config:
    driver_opts:
      o: bind
      type: none
      device: /mnt/quick/apps/volumes/vscode/gcloud
networks:
  homelab-network:
    external: true
