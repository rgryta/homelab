global:
  scrape_interval: 30s
  evaluation_interval: 30s
  external_labels:
    environment: "prod"
    monitor: "docker-cluster"

# Optional: include alerting or recording rules
# rule_files:
#   - "alerts.yml"

scrape_configs:
  # --- Prometheus self-scrape ---
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
    metrics_path: /metrics
    scrape_interval: 1m

  # --- cAdvisor: container runtime metrics ---
  - job_name: "cadvisor"
    static_configs:
      - targets: ["172.22.0.3:8080"]
    metrics_path: /metrics
    scrape_interval: 10s
    relabel_configs:
      - target_label: role
        replacement: container_monitoring

  # --- Node exporter: system-level metrics ---
  - job_name: "node"
    static_configs:
      - targets: ["172.22.0.4:9100"]
    metrics_path: /metrics
    scrape_interval: 30s
    relabel_configs:
      - target_label: role
        replacement: system_monitoring

  # --- Docker Service Discovery: app containers exposing /metrics ---
  - job_name: "docker"
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    scrape_interval: 30s
    metrics_path: /metrics

    relabel_configs:
      # Keep only containers explicitly labeled for scraping
      - source_labels: [__meta_docker_container_label_prometheus_scrape]
        regex: true
        action: keep

      # Keep only the port that matches prometheus.port label
      - source_labels: [__meta_docker_container_port_number]
        target_label: scraping_port
        action: replace
      - source_labels: [__meta_docker_container_label_prometheus_port]
        regex: '(.+)'
        target_label: scraping_port
        action: replace
      
      # Remove leading slash from container names
      - source_labels: [__meta_docker_container_name]
        regex: "/(.*)"
        target_label: container_name
        replacement: "$1"
        action: replace

      # Use container name as instance label for cleaner dashboards
      - source_labels: [container_name]
        target_label: instance
        action: replace

      # Drop cAdvisor container (avoid duplicate scrape)
      - source_labels: [__meta_docker_container_name]
        regex: "cadvisor"
        action: drop

      # Use container IP and port for scraping
      - source_labels: [__meta_docker_container_network_ip, scraping_port]
        regex: "(.+);(.+)"
        replacement: "$1:$2"
        target_label: __address__
        action: replace

      # Optional: add Docker image as a label for filtering
      - source_labels: [__meta_docker_image]
        target_label: image
        action: replace
